<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phad: The Storyteller</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rozha+One&family=Sahitya:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-paper: #fdf6e3;
            --phad-red: #8B0000;
            --phad-yellow: #f59e0b;
        }
        body {
            background-color: var(--bg-paper);
            font-family: 'Sahitya', serif;
            color: #2c0b0e;
            overflow: hidden; 
        }
        .font-display { font-family: 'Rozha One', serif; }
        
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #8B0000; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { motion } = window.Motion;

        const ChatInterface = () => {
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'Ram Ram! I am the keeper of this Phad. Which story would you like to uncover today?' }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            // 1. SAFE KEY HANDLING (Prevents the GitHub Error)
            useEffect(() => {
                const storedKey = localStorage.getItem("openrouter_key");
                if (!storedKey) {
                    const userKey = prompt("Please enter your OpenRouter API Key:\n(It is saved locally on your device)");
                    if (userKey) {
                        localStorage.setItem("openrouter_key", userKey.trim());
                        window.location.reload(); 
                    }
                }
            }, []);

            // Auto-scroll
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const handleSend = async () => {
                if (!input.trim()) return;

                const apiKey = localStorage.getItem("openrouter_key");
                if (!apiKey) {
                    alert("API Key is missing. Refresh to enter it.");
                    return;
                }

                // Add user message immediately
                const newMessages = [...messages, { role: 'user', content: input }];
                setMessages(newMessages);
                setInput('');
                setIsLoading(true);

                try {
                    // 2. THIS IS THE OPENROUTER INTEGRATION
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${apiKey}`,
                            "Content-Type": "application/json",
                            // These are the headers from your instructions:
                            "HTTP-Referer": window.location.href, 
                            "X-Title": "Phad Storyteller" 
                        },
                        body: JSON.stringify({
                            // I kept this as a free model for you. 
                            // You can change it to 'openai/gpt-4o' if you have paid credits.
                            "model": "mistralai/mistral-7b-instruct:free", 
                            "messages": newMessages
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            localStorage.removeItem("openrouter_key");
                            throw new Error("Invalid API Key. Please refresh and enter a valid key.");
                        }
                        const errData = await response.json();
                        throw new Error(errData.error?.message || `Error ${response.status}`);
                    }

                    const data = await response.json();
                    const aiContent = data.choices[0].message.content;

                    setMessages(prev => [...prev, { role: 'assistant', content: aiContent }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'assistant', content: "Forgive me, the scroll is tangled. " + error.message }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="h-screen w-full flex items-center justify-center p-4 relative">
                    <div className="absolute inset-0 z-0 opacity-10 pointer-events-none" 
                         style={{backgroundImage: `url('https://www.transparenttextures.com/patterns/canvas-orange.png')`}}>
                    </div>

                    <div className="w-full max-w-4xl h-[85vh] bg-[#fdf6e3] border-4 border-[#8B0000] rounded-sm relative shadow-2xl flex flex-col z-10 overflow-hidden">
                        
                        {/* Header */}
                        <div className="bg-[#8B0000] text-[#fdf6e3] p-4 flex items-center justify-between border-b-4 border-[#f59e0b]">
                            <div className="flex items-center gap-4">
                                <a href="index.html" className="hover:bg-white/20 p-2 rounded-full transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                </a>
                                <h1 className="font-display text-2xl tracking-wide">The Storyteller</h1>
                            </div>
                            <button onClick={() => { localStorage.removeItem("openrouter_key"); window.location.reload(); }} className="text-xs opacity-60 hover:opacity-100 underline">
                                Reset Key
                            </button>
                        </div>

                        {/* Chat Area */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 chat-scroll bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">
                            {messages.map((msg, idx) => (
                                <motion.div 
                                    key={idx}
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                >
                                    <div className={`max-w-[80%] p-4 rounded-lg shadow-md font-serif text-lg leading-relaxed
                                        ${msg.role === 'user' 
                                            ? 'bg-[#8B0000] text-[#fdf6e3] rounded-br-none' 
                                            : 'bg-[#f59e0b]/20 text-[#2c0b0e] border border-[#8B0000]/20 rounded-bl-none'
                                        }`}
                                    >
                                        {msg.content}
                                    </div>
                                </motion.div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="bg-[#f59e0b]/10 p-4 rounded-lg text-[#8B0000] italic animate-pulse">
                                        Reading the scroll...
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-white border-t-2 border-[#8B0000]/20">
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                                    placeholder="Ask about the Phad..."
                                    className="flex-1 p-4 border-2 border-[#8B0000]/30 rounded focus:outline-none focus:border-[#8B0000] bg-transparent font-serif text-lg placeholder:italic"
                                />
                                <button 
                                    onClick={handleSend}
                                    disabled={isLoading}
                                    className="bg-[#8B0000] text-[#fdf6e3] px-8 py-2 rounded font-display tracking-widest hover:bg-[#a51b1b] transition-colors disabled:opacity-50"
                                >
                                    SEND
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatInterface />);
    </script>
</body>
</html>
