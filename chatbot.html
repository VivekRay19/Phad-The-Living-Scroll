<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ask Bhopa | The Digital Storyteller</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rozha+One&family=Sahitya:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { 
            --phad-maroon: #8B0000; 
            --phad-gold: #D4AF37; 
            --paper: #FDF6E3;
        }
        
        body { 
            margin: 0; 
            font-family: 'Sahitya', serif; 
            overflow: hidden; 
            height: 100dvh; 
            color: #2c0b0e;
            background-color: #FDF6E3; 
        }

        .font-display { font-family: 'Rozha One', serif; }

        /* Paper Texture */
        .texture-overlay {
            position: fixed; inset: 0; opacity: 0.4; pointer-events: none; z-index: 1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
        }

        /* DENSE LEFT-TO-RIGHT FLOWER WAVE */
        .flower-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; pointer-events: none;
        }
        .flower {
            position: absolute; 
            left: -15%; /* Start fully off-screen left */
            color: #8B0000; 
            opacity: 0;
            animation-name: flowRight;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            will-change: transform;
        }

        @keyframes flowRight {
            0% {
                transform: translateX(0) rotate(0deg);
                opacity: 0;
            }
            5% { opacity: 0.15; } /* Fade in quickly */
            95% { opacity: 0.15; } /* Stay visible */
            100% {
                /* Move past right edge and rotate */
                transform: translateX(120vw) rotate(360deg);
                opacity: 0;
            }
        }

        /* Scrollbar */
        .chat-scroll::-webkit-scrollbar { width: 5px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #8B0000; border-radius: 20px; }

        /* Chat Bubbles */
        .bubble-user { 
            background: linear-gradient(135deg, #8B0000 0%, #600000 100%); 
            color: #fff; border-radius: 16px 16px 2px 16px; box-shadow: 0 4px 12px rgba(139, 0, 0, 0.2);
        }
        .bubble-bhopa { 
            background: #fff; color: #2c0b0e; border-radius: 16px 16px 16px 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #eaddcf;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const motion = window.Motion ? window.Motion.motion : { div: 'div', span: 'span', button: 'button' };

        // ============================================
        // 1. API CONFIGURATION
        // ============================================
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const API_KEYS_LIST = [
            "c2stb3ItdjEtZjQ3ZGU1MWI4YjMzYjYwZTI2YmY2MzYxZThmYWY2NjQ3MDNiNjgzODQxYTAyNjcyYzdhNzYzZGE0ZDc5ZTU5Zg==",
            "c2stb3ItdjEtYTEwNzQwYzYyNjI0ZjU3NzQ5ZTU0ZjkzNWE4ZjFjOTkyMGIzMjY2ZGRmYzUyOTIwMDlmNzIzMzFiYmJhYWY4YQ==",
            "c2stb3ItdjEtMTU3NTI2N2ZhNmI5ZDhmYzIyYTFmYTllNTQ2ZWM2NjJjYmNkOGFmZmUzMmEwZjJkNmZiYzliN2Y2NjRhMWMzMQ==",
            "c2stb3ItdjEtODI4ZTI5Y2ZlNjE1MDkwZDc4NDI1MGYzZjU3ZWI5NGI5NGRmZTBjNGExZmI4NGJlMGY4ZjIwN2FkZGRlNDZmOA==",
            "c2stb3ItdjEtYjk1MzQyNWUyMDQwZmUwNzUwOWYwMjExNGYyMDQ1ZWQwMmJkYTFmZjRmZWYzZGUyODFiOTRhMzM0MGYyNjkzZA==",
            "c2stb3ItdjEtOTE3MGZkMTU3NTM2NDgyMDI1YWExZmM2ZjJhZGE2ZWQ4YTEyMmM3Y2YwNmI2NjFkM2JmMDFlYTIzNDJlZTljYQ==",
            "c2stb3ItdjEtMzllYzM3ODg0MzhlZTVhMDhlZjg5ODJhZGUxMjZjZGNjOTdhYmQzZTg0MDJjOWIxNjQwNGQ2NmM3OThjMjFlNA=="
        ];
        const AI_MODELS = [
            "google/gemini-2.0-flash-exp:free", "mistralai/mistral-7b-instruct:free", "meta-llama/llama-3-8b-instruct:free",
            "microsoft/phi-3-mini-128k-instruct:free", "google/gemma-2-9b-it:free", "huggingfaceh4/zephyr-7b-beta:free"
        ];
        
        // --- UPDATED SYSTEM PROMPT: STRICT ENGLISH ---
        const SYSTEM_PROMPT = `You are "The Digital Bhopa", a traditional Rajasthani storyteller. 
        RULES: 
        1. LANGUAGE: Speak ONLY in ENGLISH. Do not use Hindi sentences. 
        2. CREATOR: Vivek Ray from Flame University. 
        3. TONE: Warm and respectful. You may use occasional honorifics like "Hukum" or "Sa" for flavor, but the explanation must be English. 
        4. UNKNOWN: "Forgive me Hukum, that story is not in my Phad." 
        5. BREVITY: Keep answers short (Max 3 sentences).`;

        // ============================================
        // 2. ANIMATION COMPONENTS
        // ============================================
        
        // Dense Left-to-Right Wave Background
        const FlowerWaveBackground = () => {
            const flowerTypes = ["‚ùÄ", "‚úø", "‚ùÅ", "‚úæ"];
            const flowers = useMemo(() => Array.from({ length: 70 }).map((_, i) => ({
                id: i,
                symbol: flowerTypes[Math.floor(Math.random() * flowerTypes.length)],
                top: `${Math.random() * 120 - 10}%`, 
                duration: `${25 + Math.random() * 30}s`, 
                delay: `-${Math.random() * 55}s`,
                size: `${14 + Math.random() * 20}px`,
                initialRotation: Math.random() * 360
            })), []);

            return (
                <div className="flower-container">
                    {flowers.map((f) => (
                        <div 
                            key={f.id} 
                            className="flower"
                            style={{ 
                                top: f.top,
                                animationDuration: f.duration, 
                                animationDelay: f.delay,
                                fontSize: f.size,
                                transform: `rotate(${f.initialRotation}deg)`
                            }}
                        >
                            {f.symbol}
                        </div>
                    ))}
                </div>
            );
        };

        // Interactive Cursor-Following Bhopa (CONSTRAINED)
        const AnimatedBhopa = ({ isTyping, statusText }) => {
            const [mouseOffset, setMouseOffset] = useState({ x: 0, y: 0 });
            const containerRef = useRef(null);

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!containerRef.current || isTyping) return;

                    const rect = containerRef.current.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;

                    // Dampening = 90 (Stays inside circle)
                    const dampen = 90; 
                    const moveX = (e.clientX - centerX) / dampen;
                    const moveY = (e.clientY - centerY) / dampen;

                    setMouseOffset({ x: moveX, y: moveY });
                };

                window.addEventListener('mousemove', handleMouseMove);
                window.addEventListener('mouseleave', () => setMouseOffset({ x:0, y:0 }));
                return () => {
                    window.removeEventListener('mousemove', handleMouseMove);
                    window.removeEventListener('mouseleave', () => setMouseOffset({ x:0, y:0 }));
                }
            }, [isTyping]);


            return (
                <div ref={containerRef} className="relative w-24 h-24 flex items-center justify-center">
                    <motion.div animate={{ rotate: 360 }} transition={{ repeat: Infinity, duration: 25, ease: "linear" }} className="absolute inset-0 border-[2px] border-dashed border-[#fdf6e3]/50 rounded-full" />
                    <motion.div animate={isTyping ? { scale: [1, 1.1, 1], opacity: [0.2, 0.5, 0.2] } : { scale: 1, opacity: 0.1 }} transition={{ repeat: Infinity, duration: 1.5 }} className="absolute inset-2 bg-[#fbbf24] rounded-full blur-md" />
                    
                    {/* Bhopa Emoji with Constrained Movement */}
                    <motion.div 
                        className="relative z-10 text-6xl drop-shadow-xl filter" 
                        animate={isTyping ? { 
                            y: [0, -3, 0], rotate: [0, -2, 2, 0], scale: [1, 1.05, 1], x: 0 
                        } : { 
                            x: mouseOffset.x, 
                            y: mouseOffset.y, 
                            rotate: mouseOffset.x * 0.5, 
                            scale: 1 
                        }} 
                        transition={isTyping ? { 
                            repeat: Infinity, duration: 0.4 
                        } : { 
                            type: "spring", stiffness: 120, damping: 20 
                        }}
                    >
                        üë≥üèΩ‚Äç‚ôÇÔ∏è
                    </motion.div>
                    
                    {/* Status Badge: Shows "Connecting to spirits..." if failed, else Speaking/Listening */}
                    <div className={`absolute -bottom-2 px-3 py-0.5 rounded-full text-[9px] font-bold tracking-widest uppercase border border-[#fbbf24]/50 shadow-sm transition-colors duration-500 whitespace-nowrap z-50 ${isTyping ? "bg-[#fbbf24] text-[#600000]" : "bg-[#8B0000] text-[#fbbf24]"}`}>
                        {statusText ? statusText : (isTyping ? "Speaking" : "Listening")}
                    </div>
                </div>
            );
        };

        const TypingDots = () => (
            <div className="flex space-x-1 p-1">
                {[0, 1, 2].map(i => (<motion.div key={i} animate={{ y: [0, -5, 0] }} transition={{ repeat: Infinity, duration: 0.6, delay: i * 0.1 }} className="w-1.5 h-1.5 bg-[#8B0000] rounded-full" />))}
            </div>
        );

        // ============================================
        // 3. MAIN APP
        // ============================================
        const ChatApp = () => {
            const [messages, setMessages] = useState([{ sender: 'bhopa', text: 'Khamma Ghani, Hukum! I am the Digital Bhopa. What story shall we unravel today?' }]);
            const [isTyping, setIsTyping] = useState(false);
            const [statusText, setStatusText] = useState(""); 
            const [input, setInput] = useState("");
            const bottomRef = useRef(null);
            const activeKeyIndex = useRef(0);

            useEffect(() => { bottomRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, isTyping]);

            // --- Robust API Logic with Forced Rotation ---
            const callAI = async (userText) => {
                const totalKeys = API_KEYS_LIST.length;
                let attempts = 0;

                while (attempts < totalKeys) {
                    // 1. Get current key
                    let apiKey;
                    try { 
                        apiKey = atob(API_KEYS_LIST[activeKeyIndex.current]); 
                    } catch(e) { 
                        activeKeyIndex.current = (activeKeyIndex.current + 1) % totalKeys;
                        attempts++;
                        continue;
                    }

                    // 2. Try Models with this Key
                    for (const model of AI_MODELS) {
                        try {
                            const response = await fetch(API_URL, {
                                method: "POST",
                                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                                body: JSON.stringify({
                                    model: model,
                                    messages: [{ role: "system", content: SYSTEM_PROMPT }, ...messages.map(m => ({ role: m.sender === 'user' ? 'user' : 'assistant', content: m.text })), { role: "user", content: userText }]
                                })
                            });

                            const data = await response.json();

                            if (!response.ok || data.error) {
                                throw new Error("API Error"); 
                            }
                            
                            if (data.choices && data.choices[0]) {
                                return data.choices[0].message.content.replace(/<s>/g, "").replace(/<\/s>/g, "").trim();
                            }
                        } catch (err) {
                            continue; 
                        }
                    }

                    // 3. Current Key failed. Show status and rotate.
                    setStatusText("Connecting to spirits...");
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    activeKeyIndex.current = (activeKeyIndex.current + 1) % totalKeys;
                    attempts++;
                }

                return "The lantern oil has run dry. Please try again later.";
            };

            const handleSend = async () => {
                if (!input.trim()) return;
                const userText = input;
                setInput("");
                setMessages(prev => [...prev, { sender: 'user', text: userText }]);
                setIsTyping(true);
                setStatusText(""); 
                
                const aiResponse = await callAI(userText);
                
                setMessages(prev => [...prev, { sender: 'bhopa', text: aiResponse }]);
                setIsTyping(false);
                setStatusText(""); 
            };

            return (
                <div className="relative h-[100dvh] w-full flex items-center justify-center overflow-hidden">
                    <div className="texture-overlay"></div>
                    
                    {/* Dense Wave Animation */}
                    <FlowerWaveBackground />
                    
                    <motion.div 
                        initial={{ opacity: 0, scale: 0.95 }} 
                        animate={{ opacity: 1, scale: 1 }} 
                        transition={{ duration: 0.8, ease: "easeOut" }}
                        className="relative z-20 w-full max-w-2xl h-full md:h-[85vh] flex flex-col md:rounded-2xl shadow-[0_20px_60px_rgba(139,0,0,0.15)] overflow-hidden border-[2px] border-[#8B0000]/30 bg-[#FDF6E3]"
                    >
                        
                        {/* Header */}
                        <div className="relative bg-[#8B0000] p-6 flex flex-col items-center border-b-[4px] border-[#D4AF37] z-20 text-[#fdf6e3] shadow-md">
                            
                            {/* --- MAIN SCROLL BUTTON --- */}
                            <a href="index.html" className="absolute top-4 right-4 bg-[#600000] hover:bg-[#4a0000] text-[#D4AF37] px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest no-underline border border-[#D4AF37]/30 transition-all hover:scale-105 shadow-sm">
                                Main Scroll ‚Ü©
                            </a>

                            {/* Interactive Bhopa Avatar with Status Text */}
                            <AnimatedBhopa isTyping={isTyping} statusText={statusText} />
                            
                            <h1 className="mt-5 font-display text-3xl tracking-wider text-[#D4AF37] drop-shadow-sm">The Digital Bhopa</h1>
                            <p className="font-serif text-sm opacity-80 tracking-widest uppercase mt-1">Interactive Storyteller</p>
                        </div>

                        {/* Chat Area */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-5 chat-scroll relative">
                            {/* Subtle Mandala in background */}
                            <div className="absolute inset-0 opacity-[0.03] pointer-events-none flex items-center justify-center">
                                <motion.div animate={{ rotate: 360 }} transition={{ duration: 120, repeat: Infinity, ease: "linear" }} className="w-[60vh] h-[60vh] border-[4px] border-[#8B0000] rounded-full border-dotted"></motion.div>
                            </div>

                            {messages.map((msg, idx) => (
                                <motion.div 
                                    key={idx} 
                                    initial={{ opacity: 0, y: 15 }} 
                                    animate={{ opacity: 1, y: 0 }}
                                    className={`flex w-full relative z-10 ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                                >
                                    <div className={`max-w-[85%] px-5 py-3 text-base md:text-lg leading-relaxed ${msg.sender === 'user' ? 'bubble-user' : 'bubble-bhopa'}`}>
                                        {msg.text}
                                    </div>
                                </motion.div>
                            ))}
                            {isTyping && (
                                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex justify-start relative z-10">
                                    <div className="bg-white border border-[#8B0000]/20 px-4 py-3 rounded-full shadow-sm"><TypingDots /></div>
                                </motion.div>
                            )}
                            <div ref={bottomRef}></div>
                        </div>

                        {/* Input Area */}
                        <div className="p-4 bg-[#FDF6E3] border-t border-[#8B0000]/20 z-20 relative">
                            <div className="flex items-center gap-2 bg-white rounded-full p-2 border-2 border-[#eaddcf] focus-within:border-[#8B0000] focus-within:ring-1 focus-within:ring-[#D4AF37] transition-all shadow-sm">
                                <input 
                                    type="text" 
                                    value={input} 
                                    onChange={(e) => setInput(e.target.value)} 
                                    onKeyDown={(e) => e.key === 'Enter' && handleSend()} 
                                    placeholder="Ask about the Phad..." 
                                    className="flex-1 bg-transparent text-[#2c0b0e] px-4 py-2 outline-none font-serif text-lg placeholder:text-[#2c0b0e]/40"
                                    disabled={isTyping} 
                                />
                                <motion.button 
                                    whileTap={{ scale: 0.95 }}
                                    onClick={handleSend} 
                                    disabled={isTyping} 
                                    className="bg-gradient-to-br from-[#8B0000] to-[#600000] text-[#D4AF37] w-12 h-12 rounded-full flex items-center justify-center shadow-md transition-all hover:brightness-110 disabled:opacity-50 disabled:grayscale"
                                >
                                    <span className="text-xl pt-0.5">‚û§</span>
                                </motion.button>
                            </div>
                        </div>

                    </motion.div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatApp />);
    </script>
</body>
</html>
